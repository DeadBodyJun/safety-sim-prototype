<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>건설현장 안전 시뮬레이션 – WebXR/Three.js Prototype</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #0b0e14;
            font-family: system-ui, Arial, sans-serif;
        }

        canvas {
            display: block;
        }

        /* 기본 UI 카드 */
        #overlayUI {
            position: fixed;
            left: 16px;
            top: 16px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
            z-index: 10;
            pointer-events: none;
        }

        .card {
            pointer-events: auto;
            background: rgba(17,20,28,0.78);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.25);
        }

        #statusCard {
            padding: 14px 16px;
            color: #e6edf3;
            min-width: 280px;
        }

            #statusCard h1 {
                margin: 0 0 8px 0;
                font-size: 16px;
                font-weight: 700;
                letter-spacing: .2px;
                color: #9cdcfe;
            }

        .pill {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            background: #1f6feb;
            color: #fff;
            font-size: 11px;
            margin-right: 6px;
        }

        #stage {
            font-weight: 700;
            color: #ffd166;
        }

        #log {
            max-height: 160px;
            overflow: auto;
            font-size: 12px;
            line-height: 1.4;
            padding-right: 4px;
        }

        /* NPC 말풍선 */
        #npcBubble {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 32px;
            max-width: min(720px, 86vw);
            color: #e6edf3;
            background: rgba(32,37,48,0.9);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 14px;
            display: none;
            z-index: 11;
        }

            #npcBubble b {
                color: #a8ffdf;
            }

        /* 중앙 조준점 */
        #reticle {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 0 6px rgba(0,0,0,0.6);
            pointer-events: none;
            z-index: 12;
            opacity: .85;
        }
        /* E키 프롬프트 */
        #prompt {
            position: fixed;
            left: 50%;
            bottom: 18%;
            transform: translateX(-50%);
            background: rgba(20,24,32,0.9);
            color: #e6edf3;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.08);
            font-size: 14px;
            display: none;
            z-index: 12;
        }

        /* 체크리스트 HUD */
        #checklist {
            position: fixed;
            right: 16px;
            top: 16px;
            width: 220px;
            background: rgba(17,20,28,.78);
            color: #d7e3f0;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.08);
            font-size: 13px;
            z-index: 10;
        }

            #checklist h2 {
                margin: 0 0 6px 0;
                font-size: 13px;
                color: #9cdcfe;
            }

            #checklist .item {
                display: flex;
                align-items: center;
                gap: 8px;
                margin: 6px 0;
            }

            #checklist .box {
                width: 14px;
                height: 14px;
                border: 1px solid #668;
                border-radius: 3px;
            }

            #checklist .done .box {
                background: #30d158;
                border-color: #30d158;
            }

            #checklist .done .label {
                color: #a3ffd6;
            }
    </style>
</head>
<body>
    <!-- 상단 상태 로그 -->
    <div id="overlayUI">
        <div id="statusCard" class="card">
            <h1>건설현장 안전 시뮬레이션</h1>
            현재 단계: <span id="stage">도착</span>
            <div style="margin-top:8px">
                <span class="pill">WASD 이동</span>
                <span class="pill">E키 상호작용</span>
            </div>
            <div id="log" style="margin-top:8px"></div>
        </div>
    </div>

    <!-- NPC 말풍선 / 조준점 / 프롬프트 / 체크리스트 -->
    <div id="npcBubble"></div>
    <div id="reticle"></div>
    <div id="prompt">E 키: 상호작용</div>
    <div id="checklist" class="card">
        <h2>안전 체크리스트</h2>
        <div id="cl-helmet" class="item"><div class="box"></div><div class="label">안전모 착용</div></div>
        <div id="cl-enter" class="item"><div class="box"></div><div class="label">현장 입장 완료</div></div>
    </div>

    <!-- Three.js + 시뮬레이션 로직 -->
    <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
    import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js';

    // === 기본 셋업 ===
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);
    document.body.appendChild(VRButton.createButton(renderer));

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b0e14);
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 100);
    camera.position.set(0, 1.6, 3.5);

    scene.add(new THREE.HemisphereLight(0xffffff, 0x223344, 0.9));
    const dir = new THREE.DirectionalLight(0xffffff, 0.6);
    dir.position.set(3,4,2); scene.add(dir);

    // === 바닥/공사 구조물 ===
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(40,40),
      new THREE.MeshStandardMaterial({ color:0x1b2533 }));
    ground.rotation.x = -Math.PI/2; scene.add(ground);
    const grid = new THREE.GridHelper(40,40,0x324d67,0x223447);
    grid.position.y = 0.002; scene.add(grid);

    const construction = new THREE.Group();
    for(let i=0;i<12;i++){
      const w=THREE.MathUtils.randFloat(0.6,1.2), h=THREE.MathUtils.randFloat(1.2,2.4), d=THREE.MathUtils.randFloat(0.6,1.4);
      const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),
        new THREE.MeshStandardMaterial({ color:0x2a2f3a }));
      m.position.set(THREE.MathUtils.randFloatSpread(6), h/2, THREE.MathUtils.randFloatSpread(6));
      construction.add(m);
    }
    construction.position.set(0,0,-4); scene.add(construction);

    // === 게이트 / 헬멧 / NPC ===
    const gate=new THREE.Mesh(new THREE.BoxGeometry(2,2.2,0.2),
      new THREE.MeshStandardMaterial({ color:0x812b2b }));
    gate.position.set(0,1.1,-2); scene.add(gate);

    const helmet=new THREE.Mesh(new THREE.CapsuleGeometry(0.22,0.08,8,16),
      new THREE.MeshStandardMaterial({ color:0xf2c14e }));
    helmet.position.set(-0.9,1.0,-1.2); scene.add(helmet);

    const npcGroup=new THREE.Group(); scene.add(npcGroup);
    const npcBody=new THREE.Mesh(new THREE.CapsuleGeometry(0.25,0.7,6,10),
      new THREE.MeshStandardMaterial({ color:0x3a86ff }));
    npcBody.position.y=1.1; npcGroup.add(npcBody);
    npcGroup.position.set(0.9,0,-1.4);
    const makeLabel=(text)=>{
      const cvs=document.createElement('canvas'); cvs.width=512; cvs.height=128;
      const ctx=cvs.getContext('2d');
      ctx.fillStyle='rgba(15,18,26,0.9)'; ctx.fillRect(0,0,512,128);
      ctx.fillStyle='#a8ffdf'; ctx.font='700 44px system-ui, Arial';
      ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(text,256,64);
      const tex=new THREE.CanvasTexture(cvs);
      const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:tex}));
      sp.scale.set(1.6,0.4,1); sp.position.set(0,2.2,0);
      return sp;
    };
    npcGroup.add(makeLabel('안전관리자'));

    // === 상태 ===
    const STAGE={Arrive:'도착',NeedHelmet:'안전모 필요',Enterable:'입장 가능',Inside:'현장 내부'};
    const state={stage:STAGE.Arrive,hasHelmet:false,gateOpen:false};
    const $stage=document.getElementById('stage');
    const $log=document.getElementById('log');
    const $npc=document.getElementById('npcBubble');
    const $prompt=document.getElementById('prompt');
    const $clHelmet=document.getElementById('cl-helmet');
    const $clEnter=document.getElementById('cl-enter');

    function log(msg,type='info'){
      const p=document.createElement('div');
      p.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
      p.style.color= type==='warn'?'#ffd166':type==='error'?'#ff6b6b':'#a3ffd6';
      $log.prepend(p);
    }
    const setStage=(s)=>{state.stage=s; $stage.textContent=s;};
    const setChecklist=(el,done)=> el.classList.toggle('done',!!done);
    function say(text,holdMs=1800){
      $npc.innerHTML=`<b>안전관리자:</b> ${text}`;
      $npc.style.display='block';
      clearTimeout(say._t);
      say._t=setTimeout(()=>{$npc.style.display='none';},holdMs);
    }

    // === 인터랙션 대상 ===
    const interactive=[helmet,gate,npcBody];
    helmet.userData.type='helmet'; gate.userData.type='gate'; npcBody.userData.type='npc';

    // === 1인칭 이동 & 마우스 시야 ===
    const move={f:0,b:0,l:0,r:0}; let dragging=false,lastX=0,lastY=0,yaw=0,pitch=0;
    function onKey(e,down){
      const k=e.key.toLowerCase();
      if(k==='w')move.f=down?1:0;
      if(k==='s')move.b=down?1:0;
      if(k==='a')move.l=down?1:0;
      if(k==='d')move.r=down?1:0;
      if(k==='e'&&down)tryInteract();
    }
    window.addEventListener('keydown',e=>onKey(e,true));
    window.addEventListener('keyup',e=>onKey(e,false));
    renderer.domElement.addEventListener('mousedown',e=>{dragging=true;lastX=e.clientX;lastY=e.clientY;});
    window.addEventListener('mouseup',()=>dragging=false);
    window.addEventListener('mousemove',e=>{
      if(!dragging)return;
      const dx=e.clientX-lastX, dy=e.clientY-lastY;
      lastX=e.clientX; lastY=e.clientY;
      const sens=0.0035;
      yaw-=dx*sens; pitch-=dy*sens;
      const lim=Math.PI/2-0.05;
      pitch=Math.max(-lim,Math.min(lim,pitch));
    });

    function updateCamera(dt){
      const qx=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),yaw);
      const qy=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),pitch);
      camera.quaternion.copy(qx).multiply(qy);
      const speed=2.0;
      const fwd=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
      const right=new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);
      fwd.y=0; right.y=0; fwd.normalize(); right.normalize();
      const dir=new THREE.Vector3();
      dir.addScaledVector(fwd,(move.f-move.b));
      dir.addScaledVector(right,(move.r-move.l));
      if(dir.lengthSq()>0){
        dir.normalize().multiplyScalar(speed*dt);
        camera.position.add(dir);
      }
    }

    // === 중앙 조준점 레이캐스트 ===
    const centerRay=new THREE.Raycaster(); const center=new THREE.Vector2(0,0);
    let lookingAt=null;
    function updateCenterPick(){
      centerRay.setFromCamera(center,camera);
      const hits=centerRay.intersectObjects(interactive,false);
      lookingAt=hits.length?hits[0].object:null;
      $prompt.style.display=lookingAt?'block':'none';
    }
    function tryInteract(){
      if(!lookingAt)return;
      const t=lookingAt.userData?.type;
      if(t==='npc')onTalkNPC();
      else if(t==='helmet')onPickupHelmet();
      else if(t==='gate')onGateInteract();
    }

    // === 상호작용 함수 ===
    function onTalkNPC(){
      if(!state.hasHelmet){
        say('현장에 들어가시려면 <b>안전모</b>를 착용해 주십시오.');
        setStage(STAGE.NeedHelmet); log('NPC: 안전모 착용 안내','warn');
      } else if(!state.gateOpen){
        say('안전모 확인되었습니다. 정문을 통과하셔도 됩니다.');
        openGate();
      } else {
        say('안전합니다. 작업 구역 내 규정을 준수해 주십시오.');
      }
    }
    function onPickupHelmet(){
      if(state.hasHelmet){ log('이미 안전모 착용 중입니다.'); return; }
      state.hasHelmet=true;
      helmet.visible=false;
      say('안전모를 착용했습니다. 정문으로 이동해 주세요.');
      setStage(STAGE.Enterable); log('안전모 착용 완료');
      setChecklist($clHelmet,true);
      if(!state.gateOpen)openGate();
    }
    function onGateInteract(){
      if(!state.hasHelmet){
        setStage(STAGE.NeedHelmet);
        say('안전모 미착용 상태입니다. 좌측의 노란 안전모를 먼저 착용해 주세요.');
        log('게이트: 안전모 미착용으로 진입 불가','warn');
        return;
      }
      if(!state.gateOpen)openGate();
      camera.position.z-=0.8;
      setStage(STAGE.Inside);
      setChecklist($clEnter,true);
      log('현장 내부로 진입');
    }
    function openGate(){
      state.gateOpen=true; log('정문 개방');
      const startY=gate.position.y,targetY=startY+1.2,t0=performance.now(),dur=450;
      gate.material.color.setHex(0x2b812b);
      function anim(t){
        const k=Math.min(1,(t-t0)/dur);
        gate.position.y=THREE.MathUtils.lerp(startY,targetY,k);
        if(k<1)requestAnimationFrame(anim);
      }
      requestAnimationFrame(anim);
    }

    // === 초기화 / 루프 ===
    setStage(STAGE.Arrive);
    log('현장에 도착했습니다. NPC에게 말을 걸거나 안전모를 착용해 보세요.');
    say('어서 오십시오. 현장 출입 전 <b>안전모</b> 착용은 필수입니다.');

    window.addEventListener('resize',()=>{
      camera.aspect=window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth,window.innerHeight);
    });

    let prevT=performance.now();
    renderer.setAnimationLoop(()=>{
      const now=performance.now();
      const dt=Math.min(0.05,(now-prevT)/1000);
      prevT=now;
      updateCamera(dt);
      updateCenterPick();
      renderer.render(scene,camera);
    });
    </script>
</body>
</html>
